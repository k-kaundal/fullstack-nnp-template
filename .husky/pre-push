#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Check Node version and switch to v22 if needed
REQUIRED_NODE_VERSION="22"
CURRENT_NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)

if [ "$CURRENT_NODE_VERSION" != "$REQUIRED_NODE_VERSION" ]; then
  echo "âš ï¸  Current Node version: v$CURRENT_NODE_VERSION"
  echo "ðŸ”„ Switching to Node v$REQUIRED_NODE_VERSION using nvm..."

  # Load nvm
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

  # Switch to Node 22
  nvm use 22

  if [ $? -ne 0 ]; then
    echo "âŒ Failed to switch to Node v22. Please install it with: nvm install 22"
    exit 1
  fi

  echo "âœ… Switched to Node $(node -v)"
fi

echo "ðŸ§ª Running tests before push..."

# Run tests in server
echo "ðŸ§ª Testing server..."
cd server && yarn test --passWithNoTests && cd ..

# Run tests in client (if any)
echo "ðŸ§ª Testing client..."
cd client && yarn test --passWithNoTests 2>/dev/null || echo "No client tests configured" && cd ..

echo "âœ… All tests passed! Pushing..."
