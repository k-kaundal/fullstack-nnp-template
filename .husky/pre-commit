#!/bin/sh

# Check Node version and switch to v22 if needed
REQUIRED_NODE_VERSION="22"
CURRENT_NODE_VERSION=$(node -v | cut -d'v' -f2 | cut -d'.' -f1)

if [ "$CURRENT_NODE_VERSION" != "$REQUIRED_NODE_VERSION" ]; then
  echo "‚ö†Ô∏è  Current Node version: v$CURRENT_NODE_VERSION"
  echo "üîÑ Switching to Node v$REQUIRED_NODE_VERSION using nvm..."

  # Load nvm
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

  # Switch to Node 22
  nvm use 22

  if [ $? -ne 0 ]; then
    echo "‚ùå Failed to switch to Node v22. Please install it with: nvm install 22"
    exit 1
  fi

  echo "‚úÖ Switched to Node $(node -v)"
fi

echo "üîç Running pre-commit checks..."

# Run lint-staged for staged files
npx lint-staged

# Check TypeScript types in both server and client
echo "üîé Type checking server..."
cd server && yarn tsc --noEmit && cd ..

echo "üîé Type checking client..."
cd client && yarn tsc --noEmit && cd ..

echo "‚úÖ Pre-commit checks passed!"
